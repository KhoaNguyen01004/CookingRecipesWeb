@model CookingRecipesWeb.Models.Recipe

@{
    ViewData["Title"] = Model.StrMeal;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <img src="@Model.StrMealThumb" class="img-fluid rounded" alt="@Model.StrMeal">
        </div>
        <div class="col-md-8">
            <h1>@Model.StrMeal</h1>
            <p><strong>Category:</strong> @Model.StrCategory</p>
            <p><strong>Area:</strong> @Model.StrArea</p>
            <h3>Ingredients</h3>
            <ul>
                @if (!string.IsNullOrEmpty(Model.StrIngredients) && !string.IsNullOrEmpty(Model.StrMeasures))
                {
                    var ingredients = Model.StrIngredients.Split(',');
                    var measures = Model.StrMeasures.Split(',');
                    for (int i = 0; i < Math.Min(ingredients.Length, measures.Length); i++)
                    {
                        var ingredient = ingredients[i]?.Trim();
                        var measure = measures[i]?.Trim();
                        if (!string.IsNullOrEmpty(ingredient))
                        {
                            <li>@measure @ingredient</li>
                        }
                    }
                }
            </ul>
            <h3>Instructions</h3>
            <p>@Model.StrInstructions</p>
            @if (!string.IsNullOrEmpty(Model.StrYoutube))
            {
                <h3>Video Tutorial</h3>
                var videoId = "";
                var url = Model.StrYoutube;
                if (url.Contains("v="))
                {
                    var parts = url.Split("v=");
                    if (parts.Length > 1)
                    {
                        videoId = parts[1].Split("&")[0];
                    }
                }
                else if (url.Contains("youtu.be/"))
                {
                    var parts = url.Split("youtu.be/");
                    if (parts.Length > 1)
                    {
                        videoId = parts[1].Split("?")[0].Split("&")[0];
                    }
                }
                else if (url.Contains("embed/"))
                {
                    var parts = url.Split("embed/");
                    if (parts.Length > 1)
                    {
                        videoId = parts[1].Split("?")[0].Split("&")[0];
                    }
                }
                if (!string.IsNullOrEmpty(videoId))
                {
                    var embedUrl = $"https://www.youtube.com/embed/{videoId}";
                    <div class="ratio ratio-16x9">
                        <iframe src="@embedUrl" title="YouTube video player" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen></iframe>
                    </div>
                }
            }
        </div>
    </div>
    <!-- Rating Section -->
    <div class="mt-4">
        <h3>Ratings & Reviews</h3>
        <div id="rating-summary" class="mb-3">
            <div class="d-flex align-items-center">
                <div id="average-rating" class="me-3">
                    <span class="h4">0.0</span>
                    <span class="text-muted">/ 5</span>
                </div>
                <div id="rating-stars" class="me-3">
                    <!-- Stars will be populated by JavaScript -->
                </div>
                <div id="total-ratings" class="text-muted">
                    (0 ratings)
                </div>
            </div>
        </div>

        @if (Context.Session.GetString("UserId") != null)
        {
            <div id="user-rating-section" class="mb-4">
                <h5>Your Rating</h5>
                <div id="user-rating-stars" class="mb-2">
                    <!-- User rating stars will be populated by JavaScript -->
                </div>
                <div id="user-rating-display" class="text-muted">
                    You haven't rated this recipe yet.
                </div>
            </div>

            <div id="review-section" class="mb-4">
                <h5>Your Review</h5>
                <textarea id="review-text" class="form-control mb-2" rows="3"
                placeholder="Write your review here..."></textarea>
                <button id="submit-review-btn" class="btn btn-primary">Submit Review</button>
                <div id="review-status" class="mt-2"></div>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Please <a href="@Url.Action("Login", "Account")">log in</a> to rate and
                review this recipe.
            </div>
        }

        <!-- Reviews List -->
        <div id="reviews-list" class="mt-4">
            <h5>Reviews</h5>
            <div id="reviews-container">
                <!-- Reviews will be loaded here -->
            </div>
        </div>

        <!-- Edit Review Modal -->
        <div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editReviewModalLabel">Edit Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="edit-review-text" class="form-control" rows="4"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-edit-review-btn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reply Modal -->
        <div class="modal fade" id="replyModal" tabindex="-1" aria-labelledby="replyModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="replyModalLabel">Reply to Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="reply-text" class="form-control" rows="3"
                            placeholder="Write your reply..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="submit-reply-btn">Submit Reply</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Reply Modal -->
        <div class="modal fade" id="editReplyModal" tabindex="-1" aria-labelledby="editReplyModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editReplyModalLabel">Edit Reply</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="edit-reply-text" class="form-control" rows="4"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-edit-reply-btn">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        @if (Context.Session.GetString("UserId") != null)
        {
            <button id="favorite-btn" class="btn btn-outline-warning mt-4 me-2">
                <i class="bi bi-heart"></i> <span id="favorite-text">Add to Favorites</span>
            </button>
        }
        <a href="@Url.Action("Index", "Home")" class="btn btn-secondary mt-4">Back to Recipes</a>
    </div>
</div>

@section Scripts {
    <script>
        window.recipeId = '@Model.Id';
    </script>
    <script src="~/js/recipe-details.js" asp-append-version="true"></script>
}